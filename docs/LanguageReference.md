# Nestor80 assembler language reference

This documents details the source file format supported by Nestor80 and lists all the available assembler instructions (called "pseudo-operators" in the MACRO-80 manual), 
both the ones inherited from MACRO-80 and the ones newly introduced by Nestor80.


## Document conventions

The following icons are used in this document:

ðŸ†• A "new" icon is used when introducing a feature or instruction that is new in Nestor80 (it wasn't available in MACRO-80).

âœ¨ A "sparks" icon is used when referring to a feature or instruction that was already available in MACRO-80 but has been enhanced or improved in a backwards-compatible way in Nestor80.

ðŸš« A "forbidden" icon is used to refer to a MACRO-80 feature or instruction that is not available or has changed in a backwards-incompatible way in Nestor80.
 Old source code intended for MACRO-80 and relying in such features or instructions will likely require changes before being suitable for assembly with Nestor80.

âš  A "warning" icon is used when discussing a tricky, subtle or confusing subject; or in general to bring attention to an important concept.


## Source code format

Nestor80 converts source code files to binary or relocatable files. A source code file is a text file in which each line is either blank, a _comment_, or a _statement_; lines
are processed one by one. The maximum supported line length is 1034 characters âœ¨ and all the usual line ending conventions are supported (CR+LF characters, LF only, and CR only). âœ¨ 
Spaces and tabs are treated equivalently, and those found at the beginning and at the end of the line are removed before the line is processed.

A comment-only line starts with a semicolon character, `;`,  and has no effect in the assembly process. A statement has the following format:

```
[label:[:]] [operator] [arguments] [;comment]
```

Any number of spaces or tabs can be used to separate the statement components.

A _label_ is a type of symbol that has the value of the location counter at the time it's defined (the value that the location counter has when the line is processed).
A label definition must end with either `:` or `::`; the later is used when assembling relocatable code to indicate that the label is public.

An _operator_ is a word that can be either the mnemonic of a CPU instruction (e.g. `LD`) or an assembler instruction. An _assembler instruction_ (called "pseudo-operator"
in the MACRO-80 manual) is an instruction for the assembler itself, for example `ORG` instructs the assembler to change the value of the current location counter.

> âš  In this manual the word "instruction" alone will be used to refer to assembler instructions, as opposed to CPU instructions.

The comment, if present, runs until the end of the line and has no effect in the assembly process. Multiline comments are supported by using the `.COMMENT` instruction.

Nestor80 supports Z80 and R800 ðŸ†• CPU instructions, being Z80 the default CPU; a `.CPU R800` instruction can be used to enable support for R800 instructions.
The 8080 CPU is not supported by Nestor80. ðŸš«

The arguments depend on the operator. For CPU instructions they will typically be one or two comma-separated values, each being either a CPU register name or an expression,
for example `LD HL,BUFFER+1000h`. There are operators with mandatory arguments, others with no arguments defined, and others with optional arguments.

Control characters other than tabs are stripped from the source lines before processing, however the form feed characters (encoded as `0xFF` in ASCII and similar encodings)
are counted before these are significant when generating a listing file (they force a listing page change).

MACRO-80 assumes that the source code is encoded in ASCII, Nestor80 however supports source code supplied in any character encoding. âœ¨

MACRO-80 treats source code characters with the high bit set as line numbers generated by a text editor, this is not the case of Nestor80. ðŸš«


### Symbols

A _symbol_ is a named 8 or 16 bit value. When assembling relocatable code this value can belong to the absolute, code or data segment or in a COMMON block. 
Valid characters for symbols are letters (any unicode letter is allowed, not just ASCII letters âœ¨), digits, and these: `$.?@_`. The first character of a symbol can't be a digit.

Nestor80 treats symbols in a case-insensitive way, e.g. `foo`, `FOO` and `Foo` refer all to the same symbol.

There's in principle no limit for the length of a symbol âœ¨, but when assembling relocatable code the maximum length for external and public symbols is 6 characters.
This limitation is given by [the format of the LINK-80 relocatable files](RelocatableFileFormat.md). Nestor80 will issue a warning if it finds two or more external symbols that are
different but share the first 6 characters (since these will get their names truncated and thus be actually the same symbol), and will throw an error if the same happens with public symbols.

When writing relocatable code, a symbol reference can have the `##` suffix to indicate that it's an external symbol (a symbol that is defined in another relocatable file). This is equivalent to
using the `EXTRN` instruction.


### Numeric constants

Numeric constants can be specified in any [radix](https://en.wikipedia.org/wiki/Radix) from 2 to 16. The default radix is 10 but this can be changed with the `.RADIX` instruction.
When the radix is 11 or higher the letters A to F (case insensitive) are used to represents the digits after the 9.

In order to specify a number in a radix different from the default one the following notations can be used
(prefixes and suffixes are case-insensitive):

Notation |  Radix
---------|-----------------
`nnnnB`     | Binary
`nnnnI` ðŸ†•  | Binary
`nnnnD`  |  Decimal
`nnnnM` ðŸ†•  |  Decimal
`nnnnO`  |   Octal
`nnnnQ`  |   Octal
`nnnnH`  |   Hexadecimal
`X'nnnn'`|  Hexadecimal
`#nnnn` ðŸ†• |   Hexadecimal

Overflow of a number beyond two bytes is ignored and the result is the number formed by the low order 16-bits
(e.g. `123456h` is actually `3456h`).

<blockquote>
âš  The <code>B</code> and <code>D</code> suffixes are actually unusable when the default radix is 12 or higher and 14 or higher, respectively. Consider the following example:

    .RADIX 16
    DEFW 1010b,1234d

  You might think that these are the binary number `1010` and the decimal number `1234`, but that's not the case: these are actually
  the hexadecimal numbers `010B` and `234D`.

  That's the reason why the new suffixes `I` (bInary) and `M` (deciMal) have been introduced in Nestor80.
</blockquote>

âš  The `#` prefix for hexadecimal numbers has been introduced in Nestor80 for compatibility with other assemblers that 
use the same notation, but in general it's recommended to use the `H` suffix instead since `#` could cause
confusion with the suffix for external symbols, `##`.

A string can be used as equivalent to the numeric constant resulting from encoding it with the current character encoding, with the following rules:

1. The current character encoding must produce at most two bytes for the string (an error will be thrown otherwise).
2. A string that produces two bytes in the current character encoding is interpreted as a big-endian value in `DEFB` instructions, and as a low-endian value elsewhere.
3. An empty string produces no output.

The second rule exists for consistency with how `DEFB` converts strings into bytes in the general case (strings of any length).

The following example listing illustrates how strings are converted to bytes following these rules:

```
                       .STRENC ASCII
0000                   defb ''
0000    41             defb 'A'
0001    42 41          defw 'AB'
0003    41 42          defb 'AB'
0005    41 42 43 44    defb 'ABCD'
```

### Strings

Strings are sequences of arbitrary characters enclosed in single quotes, `'`, or double quotes, `"`. Strings are converted to bytes using the current character encoding ðŸ†• (MACRO-80 didn't have the concept of "character encodings" and simply outputted the string bytes as they were physically stored in the source file).

The _current character encoding_ is the one specified in a `--string-encoding` argument when running Nestor80, and
can also be changed in code with the `.STRENC` instruction. You can run Nestor80 with the `--list-encodings` argument
to see a list of available encodings. The default encoding when none is specified is 7 bit ASCII.

Strings that produce two or less bytes once converted to bytes can be used anywhere a numeric value is expected,
see ["Numeric constants"](#numeric-constants). Strings of any length can be used in the `DEFB` instruction, in this case characters
are converted to bytes sequentially in the order in which they appear in the string. 

Single-quoted strings don't accept escape character with the only exception of `''`, which allows escaping the single quote itself. Example:

```
DEFB 'This ain''t gonna escape much'
```

Double-quoted strings accept escape sequences by default using the `\` character as the sequence initiator ðŸ†•. The following escape sequences are allowed (values are in the ASCII encoding except where otherwise stated):

Sequence | Name | Value
---------|------|--------
\\' | Single quote | 27h
\\" | Double quote | 22h
\\\ | Backslash | 5Ch
\0 | Null  | 00h
\a | Alert | 07h
\b | Backspace | 08h
\f | Form feed | 0Ch
\n | New line | 0Ah
\r | Carriage return | 0Dh
\t | Horizontal tab | 09h
\v | Vertical tab | 0Bh
\u | Unicode escape sequence (4 hex digits) | Example: \u0012 = 12h<br/>Example: \uABCD = CDh, ABh (in UTF-16)


The support for escape sequences in double-quoted strings can be disabled by using the Nestor80 command line argument `--no-string-escapes` or the instruction `.STRESC OFF` in code. When escape sequences are disabled the double quote
character itself can still be escaped by doubling it:

```
.STRESC OFF
db "The ""escaped"" string"
```

âš  It's recommended to disable escape sequences when compiling old code that contains strings, since in MACRO-80
the `\` character was considered a regular character with no escaping meaning.
<br/><br/>
âš  Note that when string escaping is enabled the only way to escape the double quote character is to use the `\"` sequence or the `\u0022` sequence; the special sequence `""` is available only when escape sequences are disabled.

An empty string (e.g. `DEFB ''`) produces no output.


## Absolute vs relocatable code

Nestor80 can produce both absolute ðŸ†• and relocatable files.

* An absolute file contains code intended to be executed at the fixed memory locations indicated by the `ORG` instructions found in code
  (or begninning at address 0, if no such instructions are provided). Most assemblers produce only absolute files.

* Relocatable files have [a dedicated format](RelocatableFileFormat.md) and contain relocatable code, that is, "pre-assembled" code in which
  symbols are flagged as being relative to the code segment, the data segment or a COMMON block.

Relocatable files can't be executed, instead a linker (typically LINK-80) must be used to convert it into an absolute file by providing
the start memory addresses of each segment. The linker is typically used to "glue together" two or more of these files.